<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Gator Tot's BS Game Lobby</title>
  <%- include('shared/head') %>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <div id="container">
    <%- include('shared/menu') %>
      <h1>

        Welcome, <%= username %>!
      </h1>

      Game name: <%= game_name %>

        <div>
          <h2>Current Players <%=players.length %>/<%= max_players %>:</h2>
          <ul>
            <% players.forEach(function(player) { %>
              <li>
                <%= player.username %>
              </li>
              <% }); %>
          </ul>
        </div>
        <button class="start-btn" <% if (players.length < min_players) { %>
          disabled
          title="Need at least <%= min_players %> players to start"
            <% } %>>
              Start Game
        </button>

        <div>
          <h2>Your Cards:</h2>
          <% function cardName(cardNum) { const ranks=["A", "2" , "3" , "4" , "5" , "6" , "7" , "8" , "9" , "10" , "J"
            , "Q" , "K" ]; const suits=["s", "c" , "h" , "d" ]; // Spades, Clubs, Hearts, Diamonds const
            zeroBased=cardNum - 1; const rank=ranks[zeroBased % 13]; const suit=suits[Math.floor(zeroBased / 13)];
            return rank + suit; } %>
            <ul id="my-cards">
              <% userCards.forEach(function(card) { %>
                <li><%= cardName(card.card_rank) %>
                </li>
                <% }); %>
            </ul>
        </div>
  </div>
</body>



<div id="chat-window">
  <ul id="chat-messages"></ul>
  <form id="chat-form">
    <input type="text" id="chat-input" autocomplete="off" placeholder="Type a message..." />
    <button type="submit">Send</button>
  </form>
</div>
<script>
  const roomId = "<%= gameId %>";
  const socket = io();
  socket.emit("joinRoom", roomId);

  // Listen for new messages
  socket.on(`chat:message:${roomId}`, function (data) {
    const li = document.createElement("li");
    li.textContent = `[${new Date(data.timestamp).toLocaleTimeString()}] ${data.sender.username}: ${data.message}`;
    document.getElementById("chat-messages").appendChild(li);
  });

  // Send message
  document.getElementById("chat-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const input = document.getElementById("chat-input");
    fetch(`/chat/${roomId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: input.value }),
    });
    input.value = "";
  });

  // Optionally, load previous messages
  fetch(`/chat/${roomId}/messages`)
    .then(res => res.json())
    .then(messages => {
      messages.forEach(msg => {
        const li = document.createElement("li");
        li.textContent = `[${new Date(msg.timestamp).toLocaleTimeString()}] ${msg.username}: ${msg.message_content}`;
        document.getElementById("chat-messages").appendChild(li);
      });
    });
</script>
<script src="/js/game.js"></script>

</html>